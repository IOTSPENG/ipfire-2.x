From 61b838dd574c51d96fef100285a0d225824534f9 Mon Sep 17 00:00:00 2001
From: Win King Wan <pinwing+dnsmasq@gmail.com>
Date: Wed, 21 Jan 2015 20:41:48 +0000
Subject: [PATCH 36/71] Don't reply to DHCPv6 SOLICIT messages when not
 configured for statefull DHCPv6.

---
 CHANGELOG     |  4 ++++
 src/rfc3315.c | 13 +++++++++++++
 2 files changed, 17 insertions(+)

diff --git a/CHANGELOG b/CHANGELOG
index 0076b557e95e..a4cb901e83ae 100644
--- a/CHANGELOG
+++ b/CHANGELOG
@@ -59,6 +59,10 @@ version 2.73
 	    cheaply than having dnsmasq re-read all its existing
 	    configuration each time. 
 	
+	    Don't reply to DHCPv6 SOLICIT messages if we're not 
+	    configured to do stateful DHCPv6. Thanks to Win King Wan 
+	    for the patch.
+
 	
 version 2.72
             Add ra-advrouter mode, for RFC-3775 mobile IPv6 support.
diff --git a/src/rfc3315.c b/src/rfc3315.c
index ddb390bf1136..e593ec9c362c 100644
--- a/src/rfc3315.c
+++ b/src/rfc3315.c
@@ -824,6 +824,19 @@ static int dhcp6_no_relay(struct state *state, int msg_type, void *inbuff, size_
 	  }
 	else
 	  { 
+	    /* Windows 8 always requests an address even if the Managed bit
+	       in RA is 0 and it keeps retrying if it receives a reply
+	       stating that no addresses are available. We solve this 
+	       by not replying at all if we're not configured to give any 
+	       addresses by DHCPv6. RFC 3315 17.2.1. appears to allow this. */
+	    
+	    for (c = state->context; c; c = c->current)
+	      if (!(c->flags & CONTEXT_RA_STATELESS))
+		break;
+	    
+	    if (!c)
+	      return 0;
+	    
 	    /* no address, return error */
 	    o1 = new_opt6(OPTION6_STATUS_CODE);
 	    put_opt6_short(DHCP6NOADDRS);
-- 
2.1.0

